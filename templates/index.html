<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Clinical Evidence Agent</title>
<style>
/* ── Reset & Base ────────────────────────────────────────────────────── */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg:      #0f1117;
  --surface: #1a1d27;
  --card:    #21253a;
  --border:  #2e3350;
  --accent:  #4f8ef7;
  --accent2: #38c9a4;
  --warn:    #f7c94f;
  --err:     #f75c5c;
  --text:    #e2e6f0;
  --muted:   #7c85a6;
  --radius:  10px;
  font-size: 15px;
}
body {
  background: var(--bg);
  color: var(--text);
  font-family: 'Segoe UI', 'Hiragino Sans', sans-serif;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

/* ── Header ──────────────────────────────────────────────────────────── */
header {
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  padding: 14px 24px;
  display: flex;
  align-items: center;
  gap: 12px;
}
header h1 {
  font-size: 1.1rem;
  font-weight: 700;
  letter-spacing: .03em;
  color: var(--accent);
}
header span.sub { color: var(--muted); font-size: .85rem; margin-left: auto; }

/* ── Status bar ──────────────────────────────────────────────────────── */
#status-bar {
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  padding: 7px 24px;
  display: flex;
  gap: 20px;
  font-size: .8rem;
  color: var(--muted);
}
.status-dot {
  display: inline-block;
  width: 8px; height: 8px;
  border-radius: 50%;
  background: var(--muted);
  margin-right: 5px;
  vertical-align: middle;
}
.status-dot.ok  { background: var(--accent2); }
.status-dot.err { background: var(--err); }
.status-dot.sleeping { background: var(--warn); }

/* ── Main layout ─────────────────────────────────────────────────────── */
main {
  flex: 1;
  max-width: 1100px;
  width: 100%;
  margin: 0 auto;
  padding: 24px 20px;
  display: flex;
  flex-direction: column;
  gap: 20px;
}

/* ── Query card ──────────────────────────────────────────────────────── */
.query-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px;
}
.query-card label {
  display: block;
  font-size: .8rem;
  color: var(--muted);
  margin-bottom: 6px;
  text-transform: uppercase;
  letter-spacing: .07em;
}
textarea#query-input {
  width: 100%;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--text);
  padding: 10px 12px;
  font-size: .95rem;
  resize: vertical;
  min-height: 72px;
  outline: none;
  transition: border-color .2s;
  font-family: inherit;
}
textarea#query-input:focus { border-color: var(--accent); }

.controls {
  margin-top: 12px;
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
}
.mode-group { display: flex; gap: 6px; }
.mode-btn {
  padding: 6px 14px;
  border-radius: 6px;
  border: 1px solid var(--border);
  background: var(--card);
  color: var(--muted);
  font-size: .82rem;
  cursor: pointer;
  transition: all .15s;
}
.mode-btn.active {
  background: var(--accent);
  border-color: var(--accent);
  color: #fff;
  font-weight: 600;
}
.mode-btn:hover:not(.active) { border-color: var(--accent); color: var(--text); }

#run-btn {
  margin-left: auto;
  padding: 8px 22px;
  background: var(--accent);
  border: none;
  border-radius: 6px;
  color: #fff;
  font-weight: 700;
  font-size: .9rem;
  cursor: pointer;
  transition: opacity .15s;
}
#run-btn:disabled { opacity: .4; cursor: not-allowed; }
#run-btn:hover:not(:disabled) { opacity: .85; }

#wakeup-btn {
  padding: 8px 18px;
  background: var(--warn);
  border: none;
  border-radius: 6px;
  color: var(--bg);
  font-weight: 700;
  font-size: .9rem;
  cursor: pointer;
  transition: opacity .15s;
}
#wakeup-btn:disabled { opacity: .4; cursor: not-allowed; }
#wakeup-btn:hover:not(:disabled) { opacity: .85; }

#wakeup-status {
  font-size: .82rem;
  color: var(--warn);
  align-items: center;
  gap: 6px;
}
#wakeup-status.success {
  color: var(--accent2);
}

#refresh-btn {
  padding: 5px 12px;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 5px;
  color: var(--muted);
  font-size: .75rem;
  cursor: pointer;
  transition: all .15s;
}
#refresh-btn:hover { border-color: var(--accent); color: var(--text); }

/* ── Progress ────────────────────────────────────────────────────────── */
#progress-msg {
  font-size: .82rem;
  color: var(--warn);
  display: none;
  align-items: center;
  gap: 6px;
}
.spinner {
  width: 12px; height: 12px;
  border: 2px solid var(--warn);
  border-top-color: transparent;
  border-radius: 50%;
  animation: spin .7s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* ── Context panel (RAG) ─────────────────────────────────────────────── */
#context-panel {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
  display: none;
}
.panel-header {
  background: var(--card);
  padding: 10px 16px;
  font-size: .82rem;
  color: var(--muted);
  cursor: pointer;
  display: flex;
  justify-content: space-between;
  align-items: center;
  user-select: none;
}
.panel-header:hover { color: var(--text); }
.panel-body { padding: 14px 16px; display: none; }
.panel-body.open { display: block; }

.paper-item {
  padding: 8px 0;
  border-bottom: 1px solid var(--border);
  font-size: .83rem;
}
.paper-item:last-child { border-bottom: none; }
.paper-title { color: var(--text); font-weight: 600; }
.paper-meta  { color: var(--muted); margin-top: 2px; }
.paper-score {
  display: inline-block;
  background: var(--accent);
  color: #fff;
  font-size: .72rem;
  border-radius: 4px;
  padding: 1px 6px;
  margin-left: 6px;
}

.fact-list { list-style: none; margin-top: 4px; }
.fact-list li {
  padding: 4px 0;
  font-size: .82rem;
  color: var(--muted);
  border-bottom: 1px solid var(--border);
}
.fact-list li::before { content: "•"; color: var(--accent2); margin-right: 6px; }

/* ── Response area ───────────────────────────────────────────────────── */
.response-grid {
  display: grid;
  gap: 16px;
}
.response-grid.split { grid-template-columns: 1fr 1fr; }
@media (max-width: 700px) { .response-grid.split { grid-template-columns: 1fr; } }

.response-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
  display: none;
}
.response-card .card-header {
  background: var(--card);
  padding: 9px 16px;
  font-size: .78rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: .07em;
  color: var(--muted);
}
.response-card.rag   .card-header { border-left: 3px solid var(--accent2); color: var(--accent2); }
.response-card.direct .card-header { border-left: 3px solid var(--accent); color: var(--accent); }
.response-card.single .card-header { border-left: 3px solid var(--accent); color: var(--accent); }

/* ── Bilingual display ───────────────────────────────────────────────── */
.bilingual-container {
  display: flex;
  flex-direction: column;
  gap: 0;
}
.response-section {
  border-bottom: 1px solid var(--border);
}
.response-section:last-child {
  border-bottom: none;
}
.section-label {
  background: var(--surface);
  padding: 6px 16px;
  font-size: .75rem;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: .05em;
  border-bottom: 1px solid var(--border);
}
.response-section:first-child .section-label {
  border-top-left-radius: 0;
  border-top-right-radius: 0;
}

.response-body {
  padding: 16px;
  font-family: 'Cascadia Code', 'Consolas', monospace;
  font-size: .88rem;
  line-height: 1.7;
  white-space: pre-wrap;
  word-break: break-word;
  min-height: 60px;
  color: var(--text);
}
.cursor {
  display: inline-block;
  width: 8px; height: 1em;
  background: var(--accent);
  vertical-align: text-bottom;
  animation: blink .8s step-end infinite;
  margin-left: 1px;
}
@keyframes blink { 50% { opacity: 0; } }

/* ── Error box ───────────────────────────────────────────────────────── */
#error-box {
  background: rgba(247,92,92,.1);
  border: 1px solid var(--err);
  border-radius: var(--radius);
  padding: 12px 16px;
  color: var(--err);
  font-size: .88rem;
  display: none;
}

/* ── References section ──────────────────────────────────────────────── */
.refs-section {
  border-top: 1px solid var(--border);
  padding: 12px 16px;
}
.refs-heading {
  font-size: .75rem; color: var(--muted);
  text-transform: uppercase; letter-spacing: .07em;
  margin-bottom: 8px;
}
.refs-item {
  padding: 6px 0;
  border-bottom: 1px solid var(--border);
  display: flex; align-items: flex-start; gap: 10px; flex-wrap: wrap;
}
.refs-item:last-child { border-bottom: none; }
.refs-meta {
  font-size: .82rem; color: var(--muted); flex: 1;
}
.refs-abstract-btn {
  font-size: .75rem; padding: 2px 8px;
  border: 1px solid var(--accent); border-radius: 4px;
  background: none; color: var(--accent);
  cursor: pointer; white-space: nowrap;
  transition: background .15s, color .15s;
}
.refs-abstract-btn:hover {
  background: var(--accent); color: #fff;
}

/* ── Abstract modal ──────────────────────────────────────────────────── */
.modal-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,.65);
  display: flex; align-items: center; justify-content: center;
  z-index: 1000;
}
.modal-box {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  max-width: 680px; width: 90%;
  max-height: 80vh;
  display: flex; flex-direction: column;
}
.modal-header {
  display: flex; justify-content: space-between; align-items: center;
  padding: 14px 16px;
  border-bottom: 1px solid var(--border);
  font-weight: 600;
  font-size: .92rem;
}
#modal-close {
  background: none; border: none; color: var(--muted);
  cursor: pointer; font-size: 1rem; flex-shrink: 0;
}
#modal-close:hover { color: var(--text); }
.modal-meta {
  font-size: .78rem; color: var(--muted);
  padding: 8px 16px 0;
}
.modal-text {
  padding: 14px 16px;
  font-size: .88rem; line-height: 1.7;
  overflow-y: auto;
  color: var(--text);
}
.abstract-section { margin-bottom: 14px; }
.abstract-section:last-child { margin-bottom: 0; }
.abstract-label {
  font-size: .72rem;
  font-weight: 700;
  letter-spacing: .06em;
  text-transform: uppercase;
  color: #4f8ef7;
  margin-bottom: 4px;
}
</style>
</head>
<body>

<!-- Header -->
<header>
  <svg width="26" height="26" viewBox="0 0 26 26" fill="none">
    <circle cx="13" cy="13" r="12" stroke="#4f8ef7" stroke-width="1.5"/>
    <path d="M13 7v6l4 2" stroke="#38c9a4" stroke-width="1.8" stroke-linecap="round"/>
    <path d="M8 13h2m6 0h2M13 8v2m0 6v2" stroke="#4f8ef7" stroke-width="1.4" stroke-linecap="round"/>
  </svg>
  <h1>Clinical Evidence Agent</h1>
  <span class="sub">MedGemma + Qdrant RAG</span>
</header>

<!-- Status bar -->
<div id="status-bar">
  <span><span class="status-dot" id="dot-sapbert"></span>SapBERT <span id="lbl-sapbert">確認中...</span></span>
  <span><span class="status-dot" id="dot-medgemma"></span>MedGemma <span id="lbl-medgemma">確認中...</span></span>
  <button id="refresh-btn" style="margin-left: auto;">状態を更新</button>
</div>

<main>

  <!-- Query card -->
  <div class="query-card">
    <label for="query-input">医療クエリ</label>
    <textarea id="query-input" rows="3"
      placeholder="例: What is the effect of semaglutide 2.4mg on weight loss in adults with obesity?"></textarea>
    <div class="controls">
      <div class="mode-group">
        <button class="mode-btn active" data-mode="direct">Direct</button>
        <button class="mode-btn" data-mode="rag">RAG</button>
        <button class="mode-btn" data-mode="compare">Compare</button>
      </div>
      <button id="wakeup-btn">エンドポイント起動</button>
      <div id="wakeup-status" style="display:none">
        <div class="spinner" id="wakeup-spinner"></div>
        <span id="wakeup-text">起動中...</span>
        <div id="wakeup-progress-container" style="width: 200px; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; margin-top: 8px;">
          <div id="wakeup-progress-bar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #3b82f6, #8b5cf6); transition: width 0.3s ease;"></div>
        </div>
        <span id="wakeup-progress-text" style="font-size: 12px; color: #6b7280; margin-top: 4px;">0%</span>
      </div>
      <div id="progress-msg">
        <div class="spinner"></div>
        <span id="progress-text">処理中...</span>
      </div>
      <button id="run-btn" disabled>実行</button>
    </div>
  </div>

  <!-- Error -->
  <div id="error-box"></div>

  <!-- Context panel (RAG / compare) -->
  <div id="context-panel">
    <div class="panel-header" id="ctx-toggle">
      <span>検索コンテキスト</span>
      <span id="ctx-arrow">▶</span>
    </div>
    <div class="panel-body" id="ctx-body">
      <div id="ctx-papers"></div>
      <div id="ctx-facts-wrap" style="margin-top:12px">
        <div style="font-size:.78rem;color:var(--muted);text-transform:uppercase;letter-spacing:.07em;margin-bottom:6px">Atomic Facts</div>
        <ul class="fact-list" id="ctx-facts"></ul>
      </div>
    </div>
  </div>

  <!-- Response cards -->
  <div class="response-grid" id="response-grid">
    <!-- compare: RAG side -->
    <div class="response-card rag" id="card-rag">
      <div class="card-header">RAG 回答（Qdrant 検索付き）</div>
      <div class="bilingual-container">
        <div class="response-section">
          <div class="section-label">English</div>
          <div class="response-body" id="body-rag-en"></div>
        </div>
        <div class="response-section">
          <div class="section-label">日本語</div>
          <div class="response-body" id="body-rag-jp"></div>
        </div>
      </div>
    </div>
    <!-- compare: direct side -->
    <div class="response-card direct" id="card-direct">
      <div class="card-header">Direct 回答（検索なし）</div>
      <div class="bilingual-container">
        <div class="response-section">
          <div class="section-label">English</div>
          <div class="response-body" id="body-direct-en"></div>
        </div>
        <div class="response-section">
          <div class="section-label">日本語</div>
          <div class="response-body" id="body-direct-jp"></div>
        </div>
      </div>
    </div>
    <!-- single mode -->
    <div class="response-card single" id="card-single">
      <div class="card-header" id="card-single-title">回答</div>
      <div class="bilingual-container">
        <div class="response-section">
          <div class="section-label">English</div>
          <div class="response-body" id="body-single-en"></div>
        </div>
        <div class="response-section">
          <div class="section-label">日本語</div>
          <div class="response-body" id="body-single-jp"></div>
        </div>
      </div>
    </div>
  </div>

</main>

<!-- Abstract modal -->
<div id="abstract-modal" class="modal-overlay" style="display:none">
  <div class="modal-box">
    <div class="modal-header">
      <span id="modal-title"></span>
      <button id="modal-close">✕</button>
    </div>
    <div id="modal-pmid" class="modal-meta"></div>
    <div id="modal-body" class="modal-text"></div>
  </div>
</div>

<script>
// ── Helpers ───────────────────────────────────────────────────────────────
const $  = id => document.getElementById(id);
const esc = s  => s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

// ── Status ────────────────────────────────────────────────────────────────
let endpointStatus = { sapbert: 'unknown', medgemma: 'unknown' };
let wakeupTimer = null;
let wakeupStartTime = null;

async function loadStatus() {
  try {
    const r = await fetch('/api/status');
    const d = await r.json();

    const setDot = (id, status, label) => {
      const cls = status === 'ready' ? 'ok' : (status === 'sleeping' || status === 'starting') ? 'sleeping' : 'err';
      $(`dot-${id}`).className = `status-dot ${cls}`;
      $(`lbl-${id}`).textContent = label;
    };

    // SapBERT
    if (d.sapbert_endpoint) {
      const st = d.sapbert_endpoint.status || (d.sapbert_endpoint.ok ? 'ready' : 'error');
      const label = st === 'ready' ? 'Ready' : st === 'sleeping' ? 'Sleeping' : st === 'starting' ? '起動中' : 'Error';
      setDot('sapbert', st, label);
      endpointStatus.sapbert = st;
    }

    // MedGemma
    if (d.medgemma_endpoint) {
      const st = d.medgemma_endpoint.status || (d.medgemma_endpoint.ok ? 'ready' : 'error');
      const label = st === 'ready' ? 'Ready' : st === 'sleeping' ? 'Sleeping' : st === 'starting' ? '起動中' : 'Error';
      setDot('medgemma', st, label);
      endpointStatus.medgemma = st;
    }

    return d;
  } catch(e) {
    console.error('status check failed', e);
    // Update UI to show error status
    $('dot-sapbert').className = 'status-dot err';
    $('lbl-sapbert').textContent = 'Error';
    $('dot-medgemma').className = 'status-dot err';
    $('lbl-medgemma').textContent = 'Error';
    endpointStatus = { sapbert: 'error', medgemma: 'error' };
    return null;
  }
}

async function initStatus() {
  const d = await loadStatus();
  updateButtonStates();
}

function updateButtonStates() {
  const mode = currentMode;
  const medReady = endpointStatus.medgemma === 'ready';
  const sapReady = endpointStatus.sapbert === 'ready';

  const canRun = (mode === 'direct') ? medReady : (medReady && sapReady);

  $('run-btn').disabled = !canRun;
  // Wakeup button is always visible - removed display toggle
}

async function refreshStatus() {
  await loadStatus();
  updateButtonStates();
}

async function wakeupEndpoints() {
  // Check if endpoints are already ready
  const mode = currentMode;
  const medReady = endpointStatus.medgemma === 'ready';
  const sapReady = endpointStatus.sapbert === 'ready';
  const allReady = (mode === 'direct') ? medReady : (medReady && sapReady);
  
  if (allReady) {
    return; // Already ready, nothing to do
  }
  
  $('wakeup-btn').disabled = true;
  $('wakeup-status').style.display = 'flex';
  wakeupStartTime = Date.now();

  // Fire the wake-up ping
  $('wakeup-text').textContent = '起動リクエスト送信中...';
  try { 
    await fetch('/api/wakeup', { method: 'POST' }); 
    $('wakeup-text').textContent = '起動リクエスト送信完了。状態確認中...';
  } catch(e) {
    $('wakeup-text').textContent = '起動リクエスト送信（エラーあり）。状態確認中...';
  }

  // Initial check immediately
  await checkEndpointStatus();

  // Start polling every 10 seconds
  wakeupTimer = setInterval(async () => {
    await checkEndpointStatus();
  }, 10000);
}

async function checkEndpointStatus() {
  const elapsed = Math.floor((Date.now() - wakeupStartTime) / 1000);
  
  // Timeout after 5 minutes
  if (elapsed > 300) {
    clearInterval(wakeupTimer);
    $('wakeup-status').style.display = 'none';
    $('wakeup-btn').disabled = false;
    showError('エンドポイントの起動がタイムアウトしました。再試行してください。');
    return;
  }

  const d = await loadStatus();
  if (!d) {
    $('wakeup-text').textContent = `状態確認失敗 (${elapsed}秒経過)`;
    return;
  }

  updateButtonStates();

  // Update progress bar (150 seconds = 100%)
  const progressPercent = Math.min(100, Math.round((elapsed / 150) * 100));
  $('wakeup-progress-bar').style.width = `${progressPercent}%`;
  $('wakeup-progress-text').textContent = `${progressPercent}% (${elapsed}秒経過)`;

  // Build status message
  const medStatus = endpointStatus.medgemma;
  const sapStatus = endpointStatus.sapbert;
  const mode = currentMode;
  
  let statusMsg = `MedGemma: ${medStatus}`;
  if (mode !== 'direct') {
    statusMsg += `, SapBERT: ${sapStatus}`;
  }
  $('wakeup-text').textContent = statusMsg;

  // Check if we're done
  const medReady = medStatus === 'ready';
  const sapReady = sapStatus === 'ready';
  const allReady = (mode === 'direct') ? medReady : (medReady && sapReady);

  if (allReady) {
    clearInterval(wakeupTimer);
    const statusEl = $('wakeup-status');
    statusEl.classList.add('success');
    $('wakeup-spinner').style.display = 'none';
    $('wakeup-text').textContent = '✓ すべてのエンドポイントが起動しました';
    setTimeout(() => {
      statusEl.style.display = 'none';
      statusEl.classList.remove('success');
      $('wakeup-spinner').style.display = 'block';
    }, 3000);
    // Keep wakeup button disabled once endpoints are ready
  }
}

$('wakeup-btn').addEventListener('click', wakeupEndpoints);
$('refresh-btn').addEventListener('click', refreshStatus);

initStatus();

// ── Mode selector ─────────────────────────────────────────────────────────
let currentMode = 'direct';
document.querySelectorAll('.mode-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentMode = btn.dataset.mode;
    updateButtonStates();
  });
});

// ── Context panel toggle ─────────────────────────────────────────────────
$('ctx-toggle').addEventListener('click', () => {
  const body  = $('ctx-body');
  const arrow = $('ctx-arrow');
  const open  = body.classList.toggle('open');
  arrow.textContent = open ? '▼' : '▶';
});

// ── UI state helpers ──────────────────────────────────────────────────────
function setProgress(visible, msg) {
  const el = $('progress-msg');
  el.style.display = visible ? 'flex' : 'none';
  if (msg) $('progress-text').textContent = msg;
}

function removeCursor(el) {
  const c = el.querySelector('.cursor');
  if (c) c.remove();
}

function appendToken(bodyEl, token) {
  removeCursor(bodyEl);
  bodyEl.insertAdjacentText('beforeend', token);
  const cur = document.createElement('span');
  cur.className = 'cursor';
  bodyEl.appendChild(cur);
}

function showError(msg) {
  const el = $('error-box');
  el.textContent = msg;
  el.style.display = 'block';
}

function hideError() { $('error-box').style.display = 'none'; }

function resetUI() {
  hideError();
  // hide all cards and context
  ['card-rag','card-direct','card-single','context-panel'].forEach(id => {
    $(id).style.display = 'none';
  });
  // Clear all bilingual response bodies
  ['body-rag-en','body-rag-jp','body-direct-en','body-direct-jp','body-single-en','body-single-jp'].forEach(id => {
    if ($(id)) $(id).textContent = '';
  });
  $('ctx-papers').innerHTML = '';
  $('ctx-facts').innerHTML = '';
  $('ctx-body').classList.remove('open');
  $('ctx-arrow').textContent = '▶';
  document.querySelectorAll('.refs-section').forEach(el => el.remove());
}

function renderContext(ctx) {
  // papers
  const papersEl = $('ctx-papers');
  if (ctx.papers && ctx.papers.length > 0) {
    papersEl.innerHTML = `<div style="font-size:.78rem;color:var(--muted);text-transform:uppercase;letter-spacing:.07em;margin-bottom:8px">関連論文 (Top ${ctx.papers.length})</div>`;
    ctx.papers.forEach(p => {
      const div = document.createElement('div');
      div.className = 'paper-item';
      div.innerHTML = `
        <div class="paper-title">${esc(p.title || '(タイトル不明)')}
          <span class="paper-score">${p.score}</span>
        </div>
        <div class="paper-meta">PMID: ${esc(p.paper_id)} · ${esc(p.journal || '')} ${esc(String(p.year || ''))}</div>`;
      papersEl.appendChild(div);
    });
  }
  // facts
  const factsEl = $('ctx-facts');
  if (ctx.facts && ctx.facts.length > 0) {
    ctx.facts.forEach(f => {
      const li = document.createElement('li');
      li.textContent = f;
      factsEl.appendChild(li);
    });
    $('ctx-facts-wrap').style.display = '';
  } else {
    $('ctx-facts-wrap').style.display = 'none';
  }
  $('context-panel').style.display = 'block';
  // auto-open
  $('ctx-body').classList.add('open');
  $('ctx-arrow').textContent = '▼';
}

// ── Run query ─────────────────────────────────────────────────────────────
$('run-btn').addEventListener('click', runQuery);
$('query-input').addEventListener('keydown', e => {
  if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) runQuery();
});

async function runQuery() {
  const queryText = $('query-input').value.trim();
  if (!queryText) { showError('クエリを入力してください'); return; }

  // Show immediate feedback before any async operations
  const btn = $('run-btn');
  btn.disabled = true;
  resetUI();
  setProgress(true, '接続中...');

  // Pre-flight readiness check
  setProgress(true, 'エンドポイント状態確認中...');
  const d = await loadStatus();
  if (d) {
    const medReady = endpointStatus.medgemma === 'ready';
    const sapReady = endpointStatus.sapbert === 'ready';
    const mode = currentMode;

    if (mode === 'direct' && !medReady) {
      setProgress(false);
      btn.disabled = false;
      alert('MedGemmaエンドポイントが停止中です。「エンドポイント起動」ボタンで起動してください。');
      return;
    }
    if ((mode === 'rag' || mode === 'compare') && (!medReady || !sapReady)) {
      setProgress(false);
      btn.disabled = false;
      alert('エンドポイントが停止中です。「エンドポイント起動」ボタンで起動してください。');
      return;
    }
  }

  setProgress(true, 'クエリ送信中...');

  const mode = currentMode;

  // Show appropriate cards
  const grid = $('response-grid');
  if (mode === 'compare') {
    grid.classList.add('split');
    $('card-rag').style.display = 'block';
    $('card-direct').style.display = 'block';
    $('card-single').style.display = 'none';
  } else {
    grid.classList.remove('split');
    $('card-rag').style.display = 'none';
    $('card-direct').style.display = 'none';
    $('card-single-title').textContent = mode === 'rag' ? 'RAG 回答（Qdrant 検索付き）' : 'Direct 回答';
    $('card-single').className = `response-card ${mode === 'rag' ? 'rag' : 'direct'}`;
    $('card-single').style.display = 'block';
  }

  try {
    const resp = await fetch('/api/query', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ query: queryText, mode }),
    });

    if (!resp.ok) {
      const err = await resp.json();
      showError(err.error || 'サーバーエラー');
      btn.disabled = false;
      setProgress(false);
      return;
    }

    const reader  = resp.body.getReader();
    const decoder = new TextDecoder();
    let   buffer  = '';

    while (true) {
      const { value, done } = await reader.read();
      if (done) break;

      buffer += decoder.decode(value, { stream: true });
      const lines = buffer.split('\n');
      buffer = lines.pop();  // keep incomplete line

      for (const line of lines) {
        if (!line.startsWith('data:')) continue;
        const raw = line.slice(5).trim();
        if (!raw) continue;

        let evt;
        try { evt = JSON.parse(raw); } catch { continue; }

        switch (evt.type) {
          case 'progress':
            setProgress(true, evt.message);
            break;

          case 'context':
            renderContext(evt.context);
            break;

          case 'token':
            setProgress(false);
            appendToken($('body-single-en'), evt.token);
            break;

          case 'translation':
            // Japanese translation for single mode
            setProgress(false);
            appendToken($('body-single-jp'), evt.token);
            break;

          case 'rag_token':
            setProgress(false);
            appendToken($('body-rag-en'), evt.token);
            break;

          case 'rag_translation':
            // Japanese translation for RAG answer in compare mode
            setProgress(false);
            appendToken($('body-rag-jp'), evt.token);
            break;

          case 'direct_token':
            setProgress(true, '直接回答生成中...');
            appendToken($('body-direct-en'), evt.token);
            break;

          case 'direct_translation':
            // Japanese translation for direct answer in compare mode
            setProgress(false);
            appendToken($('body-direct-jp'), evt.token);
            break;

          case 'references': {
            const cardId = (mode === 'compare') ? 'card-rag' : 'card-single';
            const card = $(cardId);
            // Remove cursors from both English and Japanese sections
            if (mode === 'compare') {
              removeCursor($('body-rag-en'));
              removeCursor($('body-rag-jp'));
            } else {
              removeCursor($('body-single-en'));
              removeCursor($('body-single-jp'));
            }

            // Remove any existing refs section (re-query reset)
            const existing = card.querySelector('.refs-section');
            if (existing) existing.remove();

            const section = document.createElement('div');
            section.className = 'refs-section';

            const heading = document.createElement('div');
            heading.className = 'refs-heading';
            heading.textContent = '参考論文';
            section.appendChild(heading);

            (evt.papers || []).forEach((p, i) => {
              const item = document.createElement('div');
              item.className = 'refs-item';

              const meta = document.createElement('div');
              meta.className = 'refs-meta';
              meta.textContent = `[${i+1}] ${p.title || p.paper_id}  ·  ${p.paper_id} | ${p.journal || ''} | ${p.year || ''}`;

              const btn = document.createElement('button');
              btn.className = 'refs-abstract-btn';
              btn.textContent = 'Abstract';
              btn.dataset.title    = p.title || p.paper_id;
              btn.dataset.pmid     = p.paper_id;
              btn.dataset.abstract = p.abstract || '（アブストラクト未収録）';
              btn.addEventListener('click', showAbstractModal);

              item.appendChild(meta);
              item.appendChild(btn);
              section.appendChild(item);
            });

            card.appendChild(section);
            break;
          }

          case 'done':
            setProgress(false);
            // remove all cursors
            document.querySelectorAll('.cursor').forEach(c => c.remove());
            break;

          case 'error':
            setProgress(false);
            showError(evt.message);
            break;
        }
      }
    }
  } catch(e) {
    showError(`通信エラー: ${e.message}`);
  } finally {
    btn.disabled = false;
    setProgress(false);
    document.querySelectorAll('.cursor').forEach(c => c.remove());
  }
}

// ── Abstract modal ─────────────────────────────────────────────────────────
function formatAbstract(text) {
  if (!text || text === '（アブストラクト未収録）') {
    return `<p style="color:var(--muted)">${esc(text || 'アブストラクト未収録')}</p>`;
  }
  const sectionRe = /^([A-Z][A-Z\s/&]+):\s*/;
  const parts = text.split(/\n\n+/).filter(p => p.trim());
  const hasLabels = parts.length > 1 && parts.some(p => sectionRe.test(p));
  if (!hasLabels) {
    return `<p style="line-height:1.7">${esc(text)}</p>`;
  }
  return parts.map(part => {
    const m = part.match(sectionRe);
    if (m) {
      const label = m[1];
      const body  = esc(part.slice(m[0].length));
      return `<div class="abstract-section"><div class="abstract-label">${esc(label)}</div><p>${body}</p></div>`;
    }
    return `<div class="abstract-section"><p>${esc(part)}</p></div>`;
  }).join('');
}

function showAbstractModal(e) {
  const btn = e.currentTarget;
  $('modal-title').textContent = btn.dataset.title;
  $('modal-pmid').textContent  = `PMID: ${btn.dataset.pmid}`;
  $('modal-body').innerHTML    = formatAbstract(btn.dataset.abstract);
  $('abstract-modal').style.display = 'flex';
}

$('modal-close').addEventListener('click', () => {
  $('abstract-modal').style.display = 'none';
});
$('abstract-modal').addEventListener('click', e => {
  if (e.target === $('abstract-modal'))
    $('abstract-modal').style.display = 'none';
});
</script>
</body>
</html>
